const glob = require('glob');
const { join, basename, extname } = require('path');

const debug = require('debug')('myassembly:tester:utils');
const utilsPath = join(__dirname);

// utils 目录中的每个文件都是一个 util
const utils = glob.sync('**/*.js', { cwd: utilsPath }).map((file) => {
  const name = basename(file, extname(file));
  const fn = require(join(utilsPath, name));
  return [name, fn];
});

const getUtils = function (memory) {
  const utilsMap = {
    ...Object.fromEntries(
      utils
        .map(([name, fn]) => {
          // __ 双下划线开头才是 utils
          if (!name.startsWith('__')) return null;
          return [name, fn(memory)];
        })
        .filter(Boolean),
    ),
    memory,
  };
  debug(Object.keys(utilsMap).join());
  return utilsMap;
};

module.exports = getUtils;
