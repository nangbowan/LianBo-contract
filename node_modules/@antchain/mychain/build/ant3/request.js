"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var s=0;s<t.length;s++){var r=t[s];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,s){return t&&_defineProperties(e.prototype,t),s&&_defineProperties(e,s),e}var Errors=require("./errors"),_XMLHttpRequest=null,_XMLHttpRequest="undefined"!=typeof dd||"undefined"!=typeof my?require("./myRequest"):"undefined"!=typeof window&&window.XMLHttpRequest?window.XMLHttpRequest:require("./utils/httpRequest"),Request=function(){function p(e){var t=e.host,s=e.port,r=e.clients,a=e.headers,n=e.timeout,o=e.senderData,i=e.cert,c=e.ca,u=e.key,e=e.passphrase;_classCallCheck(this,p),t&&s?(Array.isArray(r)||(r=[]),r=[{host:t,port:s}].concat(r)):Array.isArray(r)&&r.length&&(t=r[0].host,s=r[0].port),this.senderData=o||null,this.clients=r||[],this.currentClient=0,this.resetConnect({host:t,port:s,headers:a,timeout:n,cert:i,ca:c,key:u,passphrase:e})}return _createClass(p,[{key:"open",value:function(){var e=new _XMLHttpRequest({cert:this.cert,ca:this.ca,key:this.key,passphrase:this.passphrase,ciphers:"ALL",ecdhCurve:"secp256k1:prime256v1"});return e.withCredentials=!0,e.open("POST",this.host,!0),e.timeout=this.timeout,e.setRequestHeader("Content-Type","application/json"),this.setHeaders(e,this.headers),this.request=e}},{key:"setConfig",value:function(e){var t=e.host,s=e.port,r=e.headers,a=e.timeout,n=e.cert,o=e.ca,i=e.key,e=e.passphrase;this.host=t+(s?":"+s:"")||"http://localhost:7001",this.headers=r,this.timeout=a||5e3,this.cert=n||"",this.ca=o||"",this.key=i||"",this.passphrase=e||""}},{key:"resetConnect",value:function(e){this.setConfig(e)}},{key:"setHeaders",value:function(t,e){Array.isArray(e)&&e.forEach(function(e){t.setRequestHeader(e.name,e.value)})}},{key:"send",value:function(r,a,e){var n=this;if(console.log("[JS SDK]send: this.senderData:",this.senderData),console.log("[JS SDK]senderData: payload:",r),this.senderData&&"function"==typeof this.senderData.clientSender){var t=this.senderData.clientSender(_XMLHttpRequest,r,a,e);if(console.log("[JS SDK]senderData: payload:",r),!t)return void console.log("[JS SDK]senderData: isSendDefault:",t)}var o=this.open();this.setHeaders(o,e?e.headers:null);e=r;this.senderData&&"function"==typeof this.senderData.request&&(e=this.senderData.request(r));try{o.send(JSON.stringify(e))}catch(e){return void a(Errors.connection(this.host))}o.onreadystatechange=function(){if(4===o.readyState&&1!==o.timeout){var e=o.responseText,t=null;if(200===o.status)try{e=JSON.parse(e)||{}}catch(e){t=Errors.response()}else{n.currentClient++;var s=n.clients[n.currentClient];if(s)return void setTimeout(function(){n.resetConnect({host:s.host,port:s.port,headers:n.headers,timeout:n.timeout,cert:n.cert,ca:n.ca,key:n.key,passphrase:n.passphrase}),n.send(r,a)},1e3);t=Errors.connection(n.host),e={}}n.senderData&&"function"==typeof n.senderData.response&&(e=n.senderData.response(e)),console.log("[JS SDK]transaction: result:",e),console.log("[JS SDK]transaction: payload:",r),e.params&&r&&r.params&&r.params.transaction&&r.params.transaction.group_id&&(e.params.group_id=r.params.transaction.group_id,console.log("[JS SDK]transaction: added group_id into params for queryTransactionReceipt in next step, group_id:",r.params.transaction.group_id)),a(t,e)}},o.ontimeout=function(){a(Errors.timeout())}}}]),p}();module.exports=Request;