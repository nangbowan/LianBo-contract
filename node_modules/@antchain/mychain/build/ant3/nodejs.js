"use strict";function ownKeys(t,e){var n,a=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,n)),a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var TLS=require("./tls"),ApiParamFormat=require("./config/apiParamFormat"),requestGenerator={count:0,callbackMap:{},getCount:function(){return this.count},addCount:function(){return this.count++,this.count},setRequest:function(e){var t=this.addCount();return this.callbackMap[t]=e,t},getRequest:function(e){var t=this.callbackMap[e];if(t)return this.callbackMap[e]=null,delete this.callbackMap[e],t}},Nodejs=function(){function e(){var s=this;_classCallCheck(this,e),this.sender=null,this.sendCache=[],this.session_id="",this.callback=null,this.sendCallback=function(e,t){var n=ApiParamFormat.responseTransform(t);if("Handshake"===n.api){if(s.session_id=n.session_id||"","function"==typeof s.callback&&(s.callback(e,n),s.callback=null),s.sendCache.length)for(var a=s.sendCache.shift();a;)s._send(a.apiName,a.data,a.baseData,a.callback),a=s.sendCache.shift()}else{var r=n.sequence,r=requestGenerator.getRequest(r);"function"==typeof r&&r(e,n,t)}}}return _createClass(e,[{key:"makeSenderFunc",value:function(a){var r=this;return function(e,t,n){r.session_id?r._send(a,e,t,n):r.sendCache.push({apiName:a,data:e,baseData:t,callback:n})}}},{key:"_send",value:function(e,t,n,a){var r=requestGenerator.setRequest(function(e,t,n){"function"==typeof a&&a(e,t,n)});n.sequence=r,n.transaction_type=ApiParamFormat[e].transaction_type;var s={},r=ApiParamFormat[e];r&&"function"==typeof r.nodeInput&&(s=r.nodeInput(e,t,n)),this.send(ApiParamFormat.requestTransform(e,s))}},{key:"send",value:function(e){this.sender.send(e)}},{key:"setSender",value:function(e,t,n){var a=this;return this.callback=n,this.sender=TLS(_objectSpread(_objectSpread({},e),{},{sendCallback:this.sendCallback}),function(e){e?"function"==typeof a.callback&&(a.callback(e),a.callback=null):a.handshake(t)}),this.sender}},{key:"handshake",value:function(e){this.sender.send([e.nonce,e.userPublicKey,e.userSignature,0])}}]),e}();module.exports=Nodejs;