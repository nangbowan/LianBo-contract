"use strict";var Buffer=require("safe-buffer").Buffer,createHash=require("create-hash"),HmacDRBG=require("drbg.js/hmac"),messages=require("../messages.json"),BN=require("./bn"),ECPoint=require("./ecpoint"),g=require("./ecpointg");exports.privateKeyVerify=function(r){r=BN.fromBuffer(r);return!(r.isOverflow()||r.isZero())},exports.privateKeyExport=function(r,e){r=BN.fromBuffer(r);if(r.isOverflow()||r.isZero())throw new Error(messages.EC_PRIVATE_KEY_EXPORT_DER_FAIL);return g.mul(r).toPublicKey(e)},exports.privateKeyNegate=function(r){r=BN.fromBuffer(r);return r.isZero()?Buffer.alloc(32):(0<r.ucmp(BN.n)&&r.isub(BN.n),BN.n.sub(r).toBuffer())},exports.privateKeyModInverse=function(r){r=BN.fromBuffer(r);if(r.isOverflow()||r.isZero())throw new Error(messages.EC_PRIVATE_KEY_RANGE_INVALID);return r.uinvm().toBuffer()},exports.privateKeyTweakAdd=function(r,e){e=BN.fromBuffer(e);if(e.isOverflow())throw new Error(messages.EC_PRIVATE_KEY_TWEAK_ADD_FAIL);if(e.iadd(BN.fromBuffer(r)),e.isOverflow()&&e.isub(BN.n),e.isZero())throw new Error(messages.EC_PRIVATE_KEY_TWEAK_ADD_FAIL);return e.toBuffer()},exports.privateKeyTweakMul=function(r,e){e=BN.fromBuffer(e);if(e.isOverflow()||e.isZero())throw new Error(messages.EC_PRIVATE_KEY_TWEAK_MUL_FAIL);r=BN.fromBuffer(r);return e.umul(r).ureduce().toBuffer()},exports.publicKeyCreate=function(r,e){r=BN.fromBuffer(r);if(r.isOverflow()||r.isZero())throw new Error(messages.EC_PUBLIC_KEY_CREATE_FAIL);return g.mul(r).toPublicKey(e)},exports.publicKeyConvert=function(r,e){r=ECPoint.fromPublicKey(r);if(null===r)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);return r.toPublicKey(e)},exports.publicKeyVerify=function(r){return null!==ECPoint.fromPublicKey(r)},exports.publicKeyTweakAdd=function(r,e,f){r=ECPoint.fromPublicKey(r);if(null===r)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);if((e=BN.fromBuffer(e)).isOverflow())throw new Error(messages.EC_PUBLIC_KEY_TWEAK_ADD_FAIL);r=g.mul(e).add(r);if(r.inf)throw new Error(messages.EC_PUBLIC_KEY_TWEAK_ADD_FAIL);return r.toPublicKey(f)},exports.publicKeyTweakMul=function(r,e,f){r=ECPoint.fromPublicKey(r);if(null===r)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);if((e=BN.fromBuffer(e)).isOverflow()||e.isZero())throw new Error(messages.EC_PUBLIC_KEY_TWEAK_MUL_FAIL);return r.mul(e).toPublicKey(f)},exports.publicKeyCombine=function(r,e){for(var f=new Array(r.length),o=0;o<r.length;++o)if(f[o]=ECPoint.fromPublicKey(r[o]),null===f[o])throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);for(var u=f[0],i=1;i<f.length;++i)u=u.add(f[i]);if(u.inf)throw new Error(messages.EC_PUBLIC_KEY_COMBINE_FAIL);return u.toPublicKey(e)},exports.signatureNormalize=function(r){var e=BN.fromBuffer(r.slice(0,32)),f=BN.fromBuffer(r.slice(32,64));if(e.isOverflow()||f.isOverflow())throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);r=Buffer.from(r);return f.isHigh()&&BN.n.sub(f).toBuffer().copy(r,32),r},exports.signatureExport=function(r){var e=r.slice(0,32),r=r.slice(32,64);if(BN.fromBuffer(e).isOverflow()||BN.fromBuffer(r).isOverflow())throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);return{r:e,s:r}},exports.signatureImport=function(r){var e=BN.fromBuffer(r.r);e.isOverflow()&&(e=BN.fromNumber(0));r=BN.fromBuffer(r.s);return r.isOverflow()&&(r=BN.fromNumber(0)),Buffer.concat([e.toBuffer(),r.toBuffer()])},exports.sign=function(r,e,f,o){var u,i=BN.fromBuffer(e);if(i.isOverflow()||i.isZero())throw new Error(messages.ECDSA_SIGN_FAIL);null===f&&(u=new HmacDRBG("sha256",e,r,o),f=function(){return u.generate(32)});for(var s=BN.fromBuffer(r),n=0;;++n){var t=f(r,e,null,o,n);if(!Buffer.isBuffer(t)||32!==t.length)throw new Error(messages.ECDSA_SIGN_FAIL);var E=BN.fromBuffer(t);if(!E.isOverflow()&&!E.isZero()){var B=g.mul(E),t=B.x.fireduce();if(!t.isZero()){E=E.uinvm().umul(t.umul(i).ureduce().iadd(s).fireduce()).ureduce();if(!E.isZero()){B=(0!==B.x.ucmp(t)?2:0)|(B.y.isOdd()?1:0);return E.isHigh()&&(E=BN.n.sub(E),B^=1),{signature:Buffer.concat([t.toBuffer(),E.toBuffer()]),recovery:B}}}}}},exports.verify=function(r,e,f){var o=BN.fromBuffer(e.slice(0,32)),e=BN.fromBuffer(e.slice(32,64));if(o.isOverflow()||e.isOverflow())throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);if(e.isHigh()||o.isZero()||e.isZero())return!1;f=ECPoint.fromPublicKey(f);if(null===f)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);e=e.uinvm(),r=e.umul(BN.fromBuffer(r)).ureduce(),e=e.umul(o).ureduce(),f=g.mulAdd(r,f,e);if(f.inf)return!1;e=f.z.redSqr();return 0===o.redMul(e).ucmp(f.x)||!(0<=o.ucmp(BN.psn))&&0===o.iadd(BN.psn).redMul(e).ucmp(f.x)},exports.recover=function(r,e,f,o){var u=BN.fromBuffer(e.slice(0,32)),i=BN.fromBuffer(e.slice(32,64));if(u.isOverflow()||i.isOverflow())throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);do{if(u.isZero()||i.isZero())break;var s=u;if(f>>1){if(0<=s.ucmp(BN.psn))break;s=u.add(BN.n)}var n=Buffer.concat([Buffer.from([2+(1&f)]),s.toBuffer()]),t=ECPoint.fromPublicKey(n);if(null===t)break;s=u.uinvm(),n=BN.n.sub(BN.fromBuffer(r)).umul(s).ureduce(),s=i.umul(s).ureduce();return ECPoint.fromECJPoint(g.mulAdd(n,t,s)).toPublicKey(o)}while(0);throw new Error(messages.ECDSA_RECOVER_FAIL)},exports.ecdh=function(r,e){e=exports.ecdhUnsafe(r,e,!0);return createHash("sha256").update(e).digest()},exports.ecdhUnsafe=function(r,e,f){r=ECPoint.fromPublicKey(r);if(null===r)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);e=BN.fromBuffer(e);if(e.isOverflow()||e.isZero())throw new Error(messages.ECDH_FAIL);return r.mul(e).toPublicKey(f)};