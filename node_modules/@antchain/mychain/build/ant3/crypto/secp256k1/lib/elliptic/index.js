"use strict";var Buffer=require("safe-buffer").Buffer,createHash=require("create-hash"),BN=require("bn.js"),EC=require("elliptic").ec,messages=require("../messages.json"),ec=new EC("secp256k1"),ecparams=ec.curve;function loadCompressedPublicKey(e,r){var n=new BN(r);if(0<=n.cmp(ecparams.p))return null;r=(n=n.toRed(ecparams.red)).redSqr().redIMul(n).redIAdd(ecparams.b).redSqrt();return 3===e!==r.isOdd()&&(r=r.redNeg()),ec.keyPair({pub:{x:n,y:r}})}function loadUncompressedPublicKey(e,r,n){r=new BN(r),n=new BN(n);if(0<=r.cmp(ecparams.p)||0<=n.cmp(ecparams.p))return null;if(r=r.toRed(ecparams.red),n=n.toRed(ecparams.red),(6===e||7===e)&&n.isOdd()!==(7===e))return null;e=r.redSqr().redIMul(r);return n.redSqr().redISub(e.redIAdd(ecparams.b)).isZero()?ec.keyPair({pub:{x:r,y:n}}):null}function loadPublicKey(e){var r=e[0];switch(r){case 2:case 3:return 33!==e.length?null:loadCompressedPublicKey(r,e.slice(1,33));case 4:case 6:case 7:return 65!==e.length?null:loadUncompressedPublicKey(r,e.slice(1,33),e.slice(33,65));default:return null}}exports.privateKeyVerify=function(e){e=new BN(e);return e.cmp(ecparams.n)<0&&!e.isZero()},exports.privateKeyExport=function(e,r){var n=new BN(e);if(0<=n.cmp(ecparams.n)||n.isZero())throw new Error(messages.EC_PRIVATE_KEY_EXPORT_DER_FAIL);return Buffer.from(ec.keyFromPrivate(e).getPublic(r,!0))},exports.privateKeyNegate=function(e){e=new BN(e);return e.isZero()?Buffer.alloc(32):ecparams.n.sub(e).umod(ecparams.n).toArrayLike(Buffer,"be",32)},exports.privateKeyModInverse=function(e){e=new BN(e);if(0<=e.cmp(ecparams.n)||e.isZero())throw new Error(messages.EC_PRIVATE_KEY_RANGE_INVALID);return e.invm(ecparams.n).toArrayLike(Buffer,"be",32)},exports.privateKeyTweakAdd=function(e,r){r=new BN(r);if(0<=r.cmp(ecparams.n))throw new Error(messages.EC_PRIVATE_KEY_TWEAK_ADD_FAIL);if(r.iadd(new BN(e)),0<=r.cmp(ecparams.n)&&r.isub(ecparams.n),r.isZero())throw new Error(messages.EC_PRIVATE_KEY_TWEAK_ADD_FAIL);return r.toArrayLike(Buffer,"be",32)},exports.privateKeyTweakMul=function(e,r){r=new BN(r);if(0<=r.cmp(ecparams.n)||r.isZero())throw new Error(messages.EC_PRIVATE_KEY_TWEAK_MUL_FAIL);return r.imul(new BN(e)),(r=r.cmp(ecparams.n)?r.umod(ecparams.n):r).toArrayLike(Buffer,"be",32)},exports.publicKeyCreate=function(e,r){var n=new BN(e);if(0<=n.cmp(ecparams.n)||n.isZero())throw new Error(messages.EC_PUBLIC_KEY_CREATE_FAIL);return Buffer.from(ec.keyFromPrivate(e).getPublic(r,!0))},exports.publicKeyConvert=function(e,r){e=loadPublicKey(e);if(null===e)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);return Buffer.from(e.getPublic(r,!0))},exports.publicKeyVerify=function(e){return null!==loadPublicKey(e)},exports.publicKeyTweakAdd=function(e,r,n){e=loadPublicKey(e);if(null===e)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);if(0<=(r=new BN(r)).cmp(ecparams.n))throw new Error(messages.EC_PUBLIC_KEY_TWEAK_ADD_FAIL);e=ecparams.g.mul(r).add(e.pub);if(e.isInfinity())throw new Error(messages.EC_PUBLIC_KEY_TWEAK_ADD_FAIL);return Buffer.from(e.encode(!0,n))},exports.publicKeyTweakMul=function(e,r,n){e=loadPublicKey(e);if(null===e)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);if(0<=(r=new BN(r)).cmp(ecparams.n)||r.isZero())throw new Error(messages.EC_PUBLIC_KEY_TWEAK_MUL_FAIL);return Buffer.from(e.pub.mul(r).encode(!0,n))},exports.publicKeyCombine=function(e,r){for(var n=new Array(e.length),s=0;s<e.length;++s)if(n[s]=loadPublicKey(e[s]),null===n[s])throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);for(var a=n[0].pub,o=1;o<n.length;++o)a=a.add(n[o].pub);if(a.isInfinity())throw new Error(messages.EC_PUBLIC_KEY_COMBINE_FAIL);return Buffer.from(a.encode(!0,r))},exports.signatureNormalize=function(e){var r=new BN(e.slice(0,32)),n=new BN(e.slice(32,64));if(0<=r.cmp(ecparams.n)||0<=n.cmp(ecparams.n))throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);e=Buffer.from(e);return 1===n.cmp(ec.nh)&&ecparams.n.sub(n).toArrayLike(Buffer,"be",32).copy(e,32),e},exports.signatureExport=function(e){var r=e.slice(0,32),e=e.slice(32,64);if(0<=new BN(r).cmp(ecparams.n)||0<=new BN(e).cmp(ecparams.n))throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);return{r:r,s:e}},exports.signatureImport=function(e){var r=new BN(e.r);0<=r.cmp(ecparams.n)&&(r=new BN(0));e=new BN(e.s);return 0<=e.cmp(ecparams.n)&&(e=new BN(0)),Buffer.concat([r.toArrayLike(Buffer,"be",32),e.toArrayLike(Buffer,"be",32)])},exports.sign=function(r,n,e,s){var a;"function"==typeof e&&(a=e,e=function(e){e=a(r,n,null,s,e);if(!Buffer.isBuffer(e)||32!==e.length)throw new Error(messages.ECDSA_SIGN_FAIL);return new BN(e)});var o=new BN(n);if(0<=o.cmp(ecparams.n)||o.isZero())throw new Error(messages.ECDSA_SIGN_FAIL);e=ec.sign(r,n,{canonical:!0,k:e,pers:s});return{signature:Buffer.concat([e.r.toArrayLike(Buffer,"be",32),e.s.toArrayLike(Buffer,"be",32)]),recovery:e.recoveryParam}},exports.verify=function(e,r,n){var s={r:r.slice(0,32),s:r.slice(32,64)},a=new BN(s.r),r=new BN(s.s);if(0<=a.cmp(ecparams.n)||0<=r.cmp(ecparams.n))throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);if(1===r.cmp(ec.nh)||a.isZero()||r.isZero())return!1;n=loadPublicKey(n);if(null===n)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);return ec.verify(e,s,{x:n.pub.x,y:n.pub.y})},exports.recover=function(e,r,n,s){var a={r:r.slice(0,32),s:r.slice(32,64)},o=new BN(a.r),r=new BN(a.s);if(0<=o.cmp(ecparams.n)||0<=r.cmp(ecparams.n))throw new Error(messages.ECDSA_SIGNATURE_PARSE_FAIL);try{if(o.isZero()||r.isZero())throw new Error;var c=ec.recoverPubKey(e,a,n);return Buffer.from(c.encode(!0,s))}catch(e){throw new Error(messages.ECDSA_RECOVER_FAIL)}},exports.ecdh=function(e,r){r=exports.ecdhUnsafe(e,r,!0);return createHash("sha256").update(r).digest()},exports.ecdhUnsafe=function(e,r,n){e=loadPublicKey(e);if(null===e)throw new Error(messages.EC_PUBLIC_KEY_PARSE_FAIL);r=new BN(r);if(0<=r.cmp(ecparams.n)||r.isZero())throw new Error(messages.ECDH_FAIL);return Buffer.from(e.pub.mul(r).encode(!0,n))};