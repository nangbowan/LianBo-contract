"use strict";var Buffer=require("safe-buffer").Buffer,BN=require("./bn"),ECJPoint=require("./ecjpoint");function ECPoint(t,n){null===t&&null===n?(this.x=this.y=null,this.inf=!0):(this.x=t,this.y=n,this.inf=!1)}ECPoint.fromPublicKey=function(t){var n,r,e=t[0];return 33!==t.length||2!==e&&3!==e?65!==t.length||4!==e&&6!==e&&7!==e?null:(n=BN.fromBuffer(t.slice(1,33)),r=BN.fromBuffer(t.slice(33,65)),0<=n.ucmp(BN.p)||0<=r.ucmp(BN.p)||(6===e||7===e)&&r.isOdd()!==(7===e)||0!==n.redSqr().redMul(n).redIAdd7().ucmp(r.redSqr())?null:new ECPoint(n,r)):0<=(n=BN.fromBuffer(t.slice(1,33))).ucmp(BN.p)||null===(r=n.redSqr().redMul(n).redIAdd7().redSqrt())?null:new ECPoint(n,r=3===e!==r.isOdd()?r.redNeg():r)},ECPoint.prototype.toPublicKey=function(t){var n,r=this.x,e=this.y;return t?((n=Buffer.alloc(33))[0]=e.isOdd()?3:2,r.toBuffer().copy(n,1)):((n=Buffer.alloc(65))[0]=4,r.toBuffer().copy(n,1),e.toBuffer().copy(n,33)),n},ECPoint.fromECJPoint=function(t){if(t.inf)return new ECPoint(null,null);var n=t.z.redInvm(),r=n.redSqr();return new ECPoint(t.x.redMul(r),t.y.redMul(r).redMul(n))},ECPoint.prototype.toECJPoint=function(){return this.inf?new ECJPoint(null,null,null):new ECJPoint(this.x,this.y,ECJPoint.one)},ECPoint.prototype.neg=function(){return this.inf?this:new ECPoint(this.x,this.y.redNeg())},ECPoint.prototype.add=function(t){if(this.inf)return t;if(t.inf)return this;if(0===this.x.ucmp(t.x))return 0===this.y.ucmp(t.y)?this.dbl():new ECPoint(null,null);var n=this.y.redSub(t.y),t=(n=!n.isZero()?n.redMul(this.x.redSub(t.x).redInvm()):n).redSqr().redISub(this.x).redISub(t.x);return new ECPoint(t,n.redMul(this.x.redSub(t)).redISub(this.y))},ECPoint.prototype.dbl=function(){if(this.inf)return this;var t=this.y.redAdd(this.y);if(t.isZero())return new ECPoint(null,null);var n=this.x.redSqr(),n=n.redAdd(n).redIAdd(n).redMul(t.redInvm()),t=n.redSqr().redISub(this.x.redAdd(this.x));return new ECPoint(t,n.redMul(this.x.redSub(t)).redISub(this.y))},ECPoint.prototype.mul=function(t){for(var n=this._getNAFPoints(4),r=n.points,e=t.getNAF(n.wnd),i=new ECJPoint(null,null,null),u=e.length-1;0<=u;u--){for(var o=0;0<=u&&0===e[u];u--,++o);if(0<=u&&(o+=1),i=i.dblp(o),u<0)break;var d=e[u],i=0<d?i.mixedAdd(r[d-1>>1]):i.mixedAdd(r[-d-1>>1].neg())}return ECPoint.fromECJPoint(i)},ECPoint.prototype._getNAFPoints1=function(){return{wnd:1,points:[this]}},ECPoint.prototype._getNAFPoints=function(t){for(var n=new Array((1<<t)-1),r=(n[0]=this).dbl(),e=1;e<n.length;++e)n[e]=n[e-1].add(r);return{wnd:t,points:n}},module.exports=ECPoint;