"use strict";var Buffer=require("safe-buffer").Buffer,crypto=require("../crypto"),cs=require("./coinstring"),secp256k1=require("../secp256k1"),MASTER_SECRET=Buffer.from("Bitcoin seed","utf8"),HARDENED_OFFSET=2147483648,LEN=78,BITCOIN_VERSIONS={private:76066276,public:76067358};function HDKey(e){this.versions=e||BITCOIN_VERSIONS,this.depth=0,this.index=0,this._privateKey=null,this._publicKey=null,this.chainCode=null,this._fingerprint=0,this.parentFingerprint=0}function serialize(e,t,i){var r=Buffer.allocUnsafe(LEN);r.writeUInt32BE(t,0),r.writeUInt8(e.depth,4);t=e.depth?e.parentFingerprint:0;return r.writeUInt32BE(t,5),r.writeUInt32BE(e.index,9),e.chainCode.copy(r,13),i.copy(r,45),r}function hash160(e){e=crypto.createHash("sha256").update(e).digest();return crypto.createHash("ripemd160").update(e).digest()}Object.defineProperty(HDKey.prototype,"fingerprint",{get:function(){return this._fingerprint}}),Object.defineProperty(HDKey.prototype,"identifier",{get:function(){return this._identifier}}),Object.defineProperty(HDKey.prototype,"pubKeyHash",{get:function(){return this.identifier}}),Object.defineProperty(HDKey.prototype,"privateKey",{get:function(){return this._privateKey},set:function(e){this._privateKey=e,this._publicKey=secp256k1.publicKeyCreate(e,!0),this._identifier=hash160(this.publicKey),this._fingerprint=this._identifier.slice(0,4).readUInt32BE(0)}}),Object.defineProperty(HDKey.prototype,"publicKey",{get:function(){return this._publicKey},set:function(e){this._publicKey=secp256k1.publicKeyConvert(e,!0),this._identifier=hash160(this.publicKey),this._fingerprint=this._identifier.slice(0,4).readUInt32BE(0),this._privateKey=null}}),Object.defineProperty(HDKey.prototype,"privateExtendedKey",{get:function(){return this._privateKey?cs.encode(serialize(this,this.versions.private,Buffer.concat([Buffer.alloc(1,0),this.privateKey]))):null}}),Object.defineProperty(HDKey.prototype,"publicExtendedKey",{get:function(){return cs.encode(serialize(this,this.versions.public,this.publicKey))}}),HDKey.prototype.derive=function(e){if("m"===e||"M"===e||"m'"===e||"M'"===e)return this;var e=e.split("/"),i=this;return e.forEach(function(e,t){0!==t&&(t=1<e.length&&"'"===e[e.length-1],e=parseInt(e,10),t&&(e+=HARDENED_OFFSET),i=i.deriveChild(e))}),i},HDKey.prototype.deriveChild=function(t){var i=HARDENED_OFFSET<=t,e=Buffer.allocUnsafe(4);e.writeUInt32BE(t,0),n=i?(r=this.privateKey,n=Buffer.alloc(1,0),r=Buffer.concat([n,r]),Buffer.concat([r,e])):Buffer.concat([this.publicKey,e]);var r=crypto.createHmac("sha512",this.chainCode).update(n).digest(),e=r.slice(0,32),n=r.slice(32),r=new HDKey(this.versions);if(this.privateKey)try{r.privateKey=secp256k1.privateKeyTweakAdd(this.privateKey,e)}catch(e){return this.derive(t+1)}else try{r.publicKey=secp256k1.publicKeyTweakAdd(this.publicKey,e,!0)}catch(e){return this.derive(t+1,i)}return r.chainCode=n,r.depth=this.depth+1,r.parentFingerprint=this.fingerprint,r.index=t,r},HDKey.prototype.sign=function(e){return secp256k1.sign(e,this.privateKey).signature},HDKey.prototype.verify=function(e,t){return secp256k1.verify(e,t,this.publicKey)},HDKey.prototype.wipePrivateData=function(){return this._privateKey&&crypto.randomBytes(this._privateKey.length).copy(this._privateKey),this._privateKey=null,this},HDKey.prototype.toJSON=function(){return{xpriv:this.privateExtendedKey,xpub:this.publicExtendedKey}},HDKey.fromMasterSeed=function(e,t){var i=crypto.createHmac("sha512",MASTER_SECRET).update(e).digest(),e=i.slice(0,32),i=i.slice(32),t=new HDKey(t);return t.chainCode=i,t.privateKey=e,t},HDKey.fromExtendedKey=function(e,t){t=new HDKey(t=t||BITCOIN_VERSIONS),e=cs.decode(e),e.readUInt32BE(0);t.depth=e.readUInt8(4),t.parentFingerprint=e.readUInt32BE(5),t.index=e.readUInt32BE(9),t.chainCode=e.slice(13,45);e=e.slice(45);return 0===e.readUInt8(0)?t.privateKey=e.slice(1):t.publicKey=e,t},HDKey.fromJSON=function(e){return HDKey.fromExtendedKey(e.xpriv)},HDKey.HARDENED_OFFSET=HARDENED_OFFSET,module.exports=HDKey;