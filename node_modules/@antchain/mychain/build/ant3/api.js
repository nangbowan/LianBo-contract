"use strict";function ownKeys(t,e){var o,n=Object.keys(t);return Object.getOwnPropertySymbols&&(o=Object.getOwnPropertySymbols(t),e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,o)),n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(o),!0).forEach(function(e){_defineProperty(t,e,o[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))})}return t}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var APINAME=require("./config/apiName"),ERRORCODE=require("./config/errorCode"),Util=require("./util"),debug=require("./utils/debug"),Errors=require("./errors"),Contract=require("./contract"),apiList=[{apiName:APINAME.CreateAccount,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.TransferBalance,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.SetRecoverkey,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.PreResetPubKey,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.ResetPubKey,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.UpdateAuthMap,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.FreezeAccount,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.FreezeContract,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.NativeDepositData,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.QueryLastBlock,follow:null},{apiName:APINAME.QueryBlockHeader,follow:null},{apiName:APINAME.QueryLastBlockHeader,follow:null},{apiName:APINAME.QueryBlock,follow:null},{apiName:APINAME.QueryTransaction,follow:null},{apiName:APINAME.QueryTransactionReceipt,follow:null},{apiName:APINAME.QueryTransactionList,follow:null},{apiName:APINAME.QueryTransactionAndReceipt,follow:null},{apiName:APINAME.QueryAccount,follow:null},{apiName:APINAME.QueryContract,follow:null},{apiName:APINAME.QueryTimestamp,follow:null},{apiName:APINAME.QueryP2PStatus,follow:null},{apiName:APINAME.QueryConsensusStatus,follow:null},{apiName:APINAME.QueryCommonConsensusStatus,follow:null},{apiName:APINAME.QuerySyncStatus,follow:null},{apiName:APINAME.QueryTransactionCacheStatus,follow:null},{apiName:APINAME.QueryBlockCacheStatus,follow:null},{apiName:APINAME.QueryContractNodesStatus,follow:null},{apiName:APINAME.QueryContractConfigStatus,follow:null},{apiName:APINAME.QueryLogLevel,follow:null},{apiName:APINAME.QueryBlockProof,follow:null},{apiName:APINAME.QueryLatestStateProof,follow:null},{apiName:APINAME.QueryStateProof,follow:null},{apiName:APINAME.QueryTransactionProof,follow:null},{apiName:APINAME.QueryReceiptProof,follow:null},{apiName:APINAME.QueryBlockHeaderInfos,follow:null},{apiName:APINAME.QueryBlockReceiptInfos,follow:null},{apiName:APINAME.QueryBlockBodyInfos,follow:null},{apiName:APINAME.UpdateBlackList,follow:null},{apiName:APINAME.DeployContract,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.UpdateContract,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.CallContract,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]},{apiName:APINAME.EventAccount,follow:null},{apiName:APINAME.EventContract,follow:null},{apiName:APINAME.EventTopics,follow:null},{apiName:APINAME.EventBlock,follow:null},{apiName:APINAME.EventFetch,follow:null},{apiName:APINAME.EventCancel,follow:null},{apiName:APINAME.LocalTransaction,follow:null},{apiName:APINAME.EncryptedTransaction,follow:[{time:3e3,task:function(e,t,o){this._runWithRetry(e,t,o)}}]}],API=function(){function n(e,t){var o=this;_classCallCheck(this,n),this.mychain=e.mychain||{},this.tx_querytime=e.tx_querytime,this.tx_querycount=e.tx_querycount,this.power=e.power,this.power.setSender(_objectSpread({},e),this.getBaseData(),t),apiList.forEach(function(e){o.setApi(e)})}return _createClass(n,[{key:"_runWithRetry",value:function(a,i,e){var t=this,r=this.tx_querycount||3,l=this.tx_querytime||3e3;!function n(){debug("[JS SDK]runWithRetry: queryTransactionReceipt with retry, params data:",a),t.QueryTransactionReceipt({hash:a.hash,group_id:a.group_id||"0x0000000000000000000000000000000000000000"},function(e,t,o){t&&(t.return_code===ERRORCODE.SERVICE_TX_WAITING_EXECUTE||t.return_code===ERRORCODE.SERVICE_TX_WAITING_VERIFY||t.return_code===ERRORCODE.SERVICE_QUERY_NO_RESULT)&&0<r?setTimeout(function(){n(),r--},l):i(e,_objectSpread(_objectSpread({},t),{},{txhash:a.hash}),o)},e)}()}},{key:"getBaseData",value:function(){return{isSign:this.mychain.isSign,from:this.mychain.from,userPublicKey:this.mychain.userPublicKey,nonce:this.mychain.nonce,userPrivateKey:this.mychain.userPrivateKey,userSignature:this.mychain.userSignature,userRecoverPrivateKey:this.mychain.userRecoverPrivateKey}}},{key:"setApi",value:function(e){var i=this,t=e.apiName,r=e.follow,e=e.alias||t,o=this.power.makeSenderFunc(t);this[e]=function(e,n,a){var t=i.getBaseData();t.isSign=("boolean"==typeof e.isSign?e:t).isSign,o(e,t,function(e,t,o){Array.isArray(r)&&!e?i._followRun(t,o,n,e,r,a&&a.follow||null):"function"==typeof n&&n(e,t,o)},a)}}},{key:"callApi",value:function(e,t,o,n){if("function"!=typeof this[e])throw Errors.api(e);return this[e](t,o,n)}},{key:"_followRun",value:function(e,t,o,r,l,n){var u=this,c=0;!function n(e,t,a,i){var o=l[c];o?setTimeout(function(){o.task.call(u,e,function(e,t,o){e?"function"==typeof a&&a(e,t,o):(c++,n(t,o,a,i&&i.follow||null))},i)},u.tx_querytime||o.time):"function"==typeof a&&a(r,e,t)}(e,t,o,n)}},{key:"contract",value:function(e,t,o,n){return Util.isFunction(o)&&(n=o,o=null),new Contract({client:this,event:this.mychain.event,contractName:e,abi:t,vmType:o,callback:n})}}]),n}();module.exports=API;