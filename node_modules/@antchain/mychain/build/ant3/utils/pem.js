"use strict";var CryptoJS=require("crypto-js"),MD5=require("md5.js"),Buffer=require("safe-buffer").Buffer;function PEM(e,t,r){this.tag=t,Buffer.isBuffer(e)?this.encode(e,t,r):e&&(e=e.toString("ascii").trim(),this.decode(e,r))}module.exports=exports=function(e,t,r){return new PEM(e,t,r)},(exports.PEM=PEM).prototype.toString=function(){return this.pem},PEM.prototype.toBuffer=function(){return this.buf},PEM.prototype.decode=function(e,t){e&&(this.pem=e.toString("ascii").trim());var r,o=this.pem.split(/\r?\n/),i=o[0].match(/\-\-\-\-\-\s*BEGIN ?([^-]+)?\-\-\-\-\-/);if(!i)throw new Error("parse PEM: BEGIN not found");if(this.tag=i[1],o.shift(),"Proc-Type: 4,ENCRYPTED"===o[0]){if("string"!=typeof t)throw new Error("PEM is encrypted but no passphrase given");r=o[1].match(/DEK-Info: ([^,]+),([0-9A-F]+)/i),o.splice(0,3);e=r[1].toLowerCase(),i=Buffer(r[2],"hex"),t=passphraseToKey(e.toUpperCase(),t,i);o.pop();o=o.join("").toString("hex"),t=CryptoJS.enc.Hex.parse(t.toString("hex")),i=CryptoJS.AES.decrypt(o,t,{iv:CryptoJS.enc.Hex.parse(i.toString("hex")),padding:CryptoJS.pad.NoPadding,mode:CryptoJS.mode.CBC});r&&(this.buf=Buffer(i.toString(CryptoJS.enc.Hex),"hex"))}return this.pem="-----BEGIN"+(this.tag?" "+this.tag:"")+"-----\n"+Buffer(this.buf).toString("base64").match(/.{1,64}/g).join("\n")+"\n-----END"+(this.tag?" "+this.tag:"")+"-----",this.pem};var keyBytes={"DES-EDE3-CBC":24,"DES-CBC":8,"AES-128-CBC":16,"AES-192-CBC":24,"AES-256-CBC":32};function passphraseToKey(e,t,r){var o=keyBytes[e];if(!o){e=Object.keys(keyBytes);throw new TypeError("Unsupported type. Allowed: "+e)}var i=r.length;8!==r.length&&(r=r.slice(0,8));for(var s=!1,n=new Buffer(o),p=0;;){var f=new MD5;s?f.update(a):s=!0,f.update(t),f.update(r);for(var a=f.digest(),u=0;o&&u<16;)n[p++]=a[u],o--,u++;f=Math.min(i,16-u);if(i-=f,u+=f,0==o&&0==i)break}return n}