"use strict";var secp256k1=require("../crypto/secp256k1"),CryptoJS=require("crypto-js"),paramUtil=require("./param"),Buffer=require("safe-buffer").Buffer,PEM=require("./pem"),ECKey=require("./eckey"),RSA=require("../crypto/publicEncrypt/browser"),AES=require("browserify-aes/browser"),createHash=require("create-hash"),Base64x=require("../crypto/base64x"),bip39=require("../crypto/bip39/index"),HDKey=require("../crypto/hdkey/index"),jseu=require("js-encoding-utils"),RandomBytes=require("../crypto/publicEncrypt/randombytes"),ecies=require("../crypto/publicEncrypt/browser_ecies"),EncryptionType=require("../config/encryptionType");module.exports={getKeyInfo:function(e,r){if(r)return this.getKeyInfoFromPEM(e,r);if("string"==typeof e){r=paramUtil.toBuffer(e),e=secp256k1.publicKeyCreate(r,!1);return{privateKey:r,publicKey:e=64<e.length?e.slice(1):e}}},getKeyInfoFromPEM:function(e,r){e=PEM(e,"EC PRIVATE KEY",r).pem,r=new ECKey(e,"pem"),e=r.d,r=r.publicCodePoint;return{privateKey:e,publicKey:r=64<r.length?r.slice(1):r}},generateECKey:function(){for(var e,r=CryptoJS.lib.WordArray.random(32);e=paramUtil.toBuffer(r.toString(CryptoJS.enc.Hex)),!secp256k1.privateKeyVerify(e););var t=secp256k1.publicKeyCreate(e,!1);return{privateKey:e,publicKey:t=64<t.length?t.slice(1):t}},sign:function(e,r){paramUtil.isBuffer(e)?32!==e.length&&(e=paramUtil.toBuffer(paramUtil.getHash(e))):e=paramUtil.isString(e)&&0===e.indexOf("0x")?paramUtil.toBuffer(e):paramUtil.toBuffer(paramUtil.getHash(e));r=secp256k1.sign(e,r);return Buffer.concat([r.signature,Buffer.from([r.recovery])],65)},generateAESKey:function(e,r){if(!e||!r)throw new Error("aes password or tx hash is invalid"+e+"..."+r);if(paramUtil.isString(e)&&(e="0x"===e.substr(0,2)?Buffer.from(e.substr(2),"hex"):Buffer.from(e,"ascii")),!paramUtil.isBuffer(e))throw new Error("aes password is invalid");return r=paramUtil.hexToBuffer(r),createHash("sha256").update(Buffer.concat([e,r])).digest().slice(0,16)},randomBytes:function(e){if("number"!=typeof e)throw new Error("param is not number.");return paramUtil.bufferToHex(RandomBytes(e))},randomNumber:function(){return RandomBytes(4).readUInt32BE(0)},sealSGXWithPassword:function(e,r,t,i,a){return a===EncryptionType.ECIES?this.sealEccSGX(e,r,this.generateAESKey(t,i)):this.sealRsaSGX(e,r,this.generateAESKey(t,i))},sealRsaSGX:function(e,r,t){if(t=t||RandomBytes(16),t=paramUtil.hexToBuffer(t),!e)throw new Error("rsa_pub_key is invalid");paramUtil.isString(e)&&-1===e.indexOf("PUBLIC KEY")&&("0x"===e.substr(0,2)&&(e=e.substr(2)),e=Base64x.hextopem(e,"PUBLIC KEY"));var i=RandomBytes(12),r=this.encryptAES(r,t,i),t=RSA.publicEncrypt(e,t);t.length<256&&(a=Buffer.alloc(256),t.copy(a,256-t.length),t=a);var a=new Buffer(2);return a.writeUInt16BE(1),"0x"+Buffer.concat([a,t,i,Buffer.from(r.authTag,"hex"),Buffer.from(r.data,"hex")]).toString("hex")},sealEccSGX:function(e,r,t){if(!e)throw new Error("ecc_pub_key is invalid");t=t||RandomBytes(16),t=paramUtil.hexToBuffer(t);var i=RandomBytes(12),a=this.encryptAES(r,t,i),n=Buffer.from(a.authTag,"hex"),o=Buffer.from(a.data,"hex"),r={iv:i},a=jseu.formatter.pemToBin(e.toString()),a=Buffer.from(a);e=a.slice(a.byteLength-65,a.byteLength),e=paramUtil.hexToBuffer(e),(r=ecies.encrypt(e,t,r)).length<109&&(f=Buffer.alloc(109),r.copy(f,109-r.length),r=f);var f=new Buffer(2);f.writeUInt16BE(320);r=paramUtil.hexToBuffer(r);return"0x"+Buffer.concat([f,r,i,n,o]).toString("hex")},encryptAES:function(e,r,t){if(!r||!t)throw new Error("aes empty key or iv!");e=paramUtil.hexToBuffer(e),r=paramUtil.hexToBuffer(r);t=AES.createCipheriv("aes-128-gcm",r,t);t.setAutoPadding(!1);e=t.update(e).toString("hex");return t.final(),{data:e,authTag:t.getAuthTag().toString("hex")}},decryptAES:function(e,r){if(!r||!e)throw new Error("aes empty key or data!");e=paramUtil.hexToBuffer(e),r=paramUtil.hexToBuffer(r);var t=e.length-16,i=e.length,a=e.slice(t,i),i=e.slice(t-=12,i-=16),t=e.slice(0,t),i=AES.createDecipheriv("aes-128-gcm",r,i);return i.setAuthTag(a),"0x"+i.update(t).toString("hex")},decryptAESWithIV:function(e,r,t,i){if(!r||!t||!i)throw new Error("aes empty key or iv or tag!");e=paramUtil.hexToBuffer(e),r=paramUtil.hexToBuffer(r),t=paramUtil.hexToBuffer(t),i=paramUtil.hexToBuffer(i);t=AES.createDecipheriv("aes-128-gcm",r,t);return t.setAuthTag(i),"0x"+t.update(e).toString("hex")},decryptAESWithPassword:function(e,r,t){return this.decryptAES(e,this.generateAESKey(r,t))},decryptAESTX:function(e,r){if(!r||!e)throw new Error("aes empty key or data!");e=paramUtil.hexToBuffer(e),r=paramUtil.hexToBuffer(r);var t=e.slice(0,12),i=e.slice(12,28);a=e.length;var a=e.slice(28,a),t=AES.createDecipheriv("aes-128-gcm",r,t);return t.setAuthTag(i),"0x"+t.update(a).toString("hex")},bip39:bip39,HDKey:HDKey};