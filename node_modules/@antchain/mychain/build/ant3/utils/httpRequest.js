"use strict";var fs=require("fs"),Url=require("url");function XMLHttpRequest(p){p=p||{};var E,l,f=this,T=require("http"),y=require("https"),S={},r=!1,e={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"},N=Object.assign({},e),n=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"],o=["TRACE","TRACK","CONNECT"],R=!1,D=!1,a={};this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.onreadystatechange=null,this.responseText="",this.responseXML="",this.status=null,this.statusText=null;this.open=function(e,t,s,r,n){if(this.abort(),D=!1,!(a=e)||-1!==o.indexOf(a))throw"SecurityError: Request method not allowed";var a;S={method:e,url:t.toString(),async:"boolean"!=typeof s||s,user:r||null,password:n||null},O(this.OPENED)},this.setDisableHeaderCheck=function(e){r=e},this.setRequestHeader=function(e,t){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";if(s=e,!(r||s&&-1===n.indexOf(s.toLowerCase())))return console.warn('Refused to set unsafe header "'+e+'"'),!1;var s;if(R)throw"INVALID_STATE_ERR: send flag is true";return N[e]=t,!0},this.getResponseHeader=function(e){return"string"==typeof e&&this.readyState>this.OPENED&&l.headers[e.toLowerCase()]&&!D?l.headers[e.toLowerCase()]:null},this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||D)return"";var e,t="";for(e in l.headers)"set-cookie"!==e&&"set-cookie2"!==e&&(t+=e+": "+l.headers[e]+"\r\n");return t.substr(0,t.length-2)},this.getRequestHeader=function(e){return"string"==typeof e&&N[e]?N[e]:""},this.send=function(e){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: connection must be opened before send() is called";if(R)throw"INVALID_STATE_ERR: send has already been called";var s,r=!1,t=!1,n=Url.parse(S.url);switch(n.protocol){case"https:":r=!0;case"http:":s=n.hostname;break;case"file:":t=!0;break;case void 0:case"":s="localhost";break;default:throw"Protocol not supported."}if(t){if("GET"!==S.method)throw"XMLHttpRequest: Only GET method is supported";if(S.async)fs.readFile(n.pathname,"utf8",function(e,t){e?f.handleError(e):(f.status=200,f.responseText=t,O(f.DONE))});else try{this.responseText=fs.readFileSync(n.pathname,"utf8"),this.status=200,O(f.DONE)}catch(e){this.handleError(e)}}else{var a=n.port||(r?443:80),o=n.pathname+(n.search||"");N.Host=s,r&&443===a||80===a||(N.Host+=":"+n.port),S.user&&(void 0===S.password&&(S.password=""),i=new Buffer(S.user+":"+S.password),N.Authorization="Basic "+i.toString("base64")),"GET"===S.method||"HEAD"===S.method?e=null:e?(N["Content-Length"]=Buffer.isBuffer(e)?e.length:Buffer.byteLength(e),N["Content-Type"]||(N["Content-Type"]="text/plain;charset=UTF-8")):"POST"===S.method&&(N["Content-Length"]=0);var i=p.agent||!1,i={host:s,port:a,path:o,method:S.method,headers:N,agent:i};if(r&&(i.pfx=p.pfx,i.key=p.key,i.passphrase=p.passphrase,i.cert=p.cert,i.ca=p.ca,i.ciphers=p.ciphers,i.rejectUnauthorized=p.rejectUnauthorized),D=!1,S.async){var h=(r?y:T).request;R=!0,f.dispatchEvent("readystatechange");var c=function e(t){if(302===(l=t).statusCode||303===l.statusCode||307===l.statusCode){S.url=l.headers.location;t=Url.parse(S.url);s=t.hostname;t={hostname:t.hostname,port:t.port,path:t.path,method:303===l.statusCode?"GET":S.method,headers:N};return r&&(t.pfx=p.pfx,t.key=p.key,t.passphrase=p.passphrase,t.cert=p.cert,t.ca=p.ca,t.ciphers=p.ciphers,t.rejectUnauthorized=p.rejectUnauthorized),void(E=h(t,e).on("error",d)).end()}l&&l.setEncoding&&l.setEncoding("utf8"),O(f.HEADERS_RECEIVED),f.status=l.statusCode,l.on("data",function(e){e&&(f.responseText+=e),R&&O(f.LOADING)}),l.on("end",function(){R&&(R=!1,O(f.DONE))}),l.on("error",function(e){f.handleError(e)})},d=function(e){f.handleError(e)};E=h(i,c).on("error",d),e&&E.write(e),E.end(),f.dispatchEvent("loadstart")}else{var c=".node-xmlhttprequest-content-"+process.pid,u=".node-xmlhttprequest-sync-"+process.pid;fs.writeFileSync(u,"","utf8");for(JSON.stringify(i),e&&e.replace(/'/g,"\\'");fs.existsSync(u););f.responseText=fs.readFileSync(c,"utf8"),fs.unlinkSync(c),f.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)?(c=f.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,""),f.handleError(c)):(f.status=f.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1"),f.responseText=f.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1"),O(f.DONE))}}},this.handleError=function(e){this.status=503,this.statusText=e,this.responseText=e.stack,D=!0,O(this.DONE)},this.abort=function(){E&&(E.abort(),E=null),N=Object.assign({},e),this.responseText="",this.responseXML="",D=!0,this.readyState===this.UNSENT||this.readyState===this.OPENED&&!R||this.readyState===this.DONE||(R=!1,O(this.DONE)),this.readyState=this.UNSENT},this.addEventListener=function(e,t){e in a||(a[e]=[]),a[e].push(t)},this.removeEventListener=function(e,t){e in a&&(a[e]=a[e].filter(function(e){return e!==t}))},this.dispatchEvent=function(e){if("function"==typeof f["on"+e]&&f["on"+e](),e in a)for(var t=0,s=a[e].length;t<s;t++)a[e][t].call(f)};var O=function(e){f.readyState!==e&&(f.readyState=e,(S.async||f.readyState<f.OPENED||f.readyState===f.DONE)&&f.dispatchEvent("readystatechange"),f.readyState!==f.DONE||D||(f.dispatchEvent("load"),f.dispatchEvent("loadend")))}}module.exports=XMLHttpRequest;