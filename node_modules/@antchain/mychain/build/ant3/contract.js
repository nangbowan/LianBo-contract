"use strict";function ownKeys(t,e){var r,c=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),c.push.apply(c,r)),c}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var c=t[r];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(e,c.key,c)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var Util=require("./util"),Errors=require("./errors"),VmType=require("./config/vmType"),SolContract=require("./solContract"),WasmContract=require("./wasmContract");function paramCheck(e,t){if(e)if(Util.isBigNumber(t)&&(t=Util.toDecimal(t)),Array.isArray(e)){if(-1===e.indexOf(t))return!1}else if(t!==e)return!1;return!0}function eventFilterCheck(e,t){if(!Array.isArray(e))return paramCheck(t[0],e);for(var r=0;r<e.length;r++){var c=e[r],c=paramCheck(t[r],c);if(!c)return c}return!0}var Contract=function(){function u(e){var t=this,r=e.client,c=e.event,n=e.contractName,a=e.abi,l=e.vmType,i=e.callback;if(_classCallCheck(this,u),!n)throw new Error("ERROR: The contractName is null");this.client=r,this.event=c,this.contractName=n,this.abi=a||[],this.vmType=l||VmType.EVM,this.deploy_type=0,this.callCache=[];var o=SolContract;switch(this.vmType){case VmType.EVM:o=SolContract;break;case VmType.WASM:o=WasmContract}this.contractTpl=new o({contract:this,contractName:n,abi:this.abi}),setTimeout(function(){"function"==typeof i&&i(null,t)},1)}return _createClass(u,[{key:"callbackRun",value:function(e,t,r,c){this.deploy_type=t?2:0,"function"==typeof e&&e(t,r,c)}},{key:"new",value:function(e){var c=this,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length?arguments[2]:void 0,r="";try{r=this.contractTpl.newInput(e,t.parameters),t.parameters=null,delete t.parameters}catch(e){return this.callbackRun(n,e,this,null),this}this.deploy_type=1;e=_objectSpread({},t);e.from=t.from,e.to=t.contractName||this.contractName,e.data={code:r};r=this.client.DeployContract;return e.encrypt&&(r=this.client.EncryptedTransaction,e.apiName="DeployContract"),e.local&&(r=this.client.LocalTransaction,e.apiName="DeployContract"),r.call(this.client,e,function(e,t){if(e)c.callbackRun(n,e,c,t);else if(0===t.return_code||408===t.return_code)if(t.receipt)if(408!==t.return_code)if(0===t.receipt.result){if(c.callbackRun(n,null,c,t),c.callCache.length)for(var r=c.callCache.shift();r;)c.contractTpl.doPayload(r),r=c.callCache.shift();c.callCache=[]}else c.callbackRun(n,Errors.receiptResult(t.receipt.result),c,t);else c.callbackRun(n,Errors.codeResult(t.return_code,t.receipt.result),c,t);else c.callbackRun(n,Errors.receiptResult(null),c,t);else c.callbackRun(n,Errors.returnCode(t.return_code),c,t)}),this}},{key:"updateInput",value:function(e){return 0===e.indexOf("0x")&&(e=e.slice(2)),"0x"+this.vmType+e}},{key:"update",value:function(e){var c=this,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length?arguments[2]:void 0,r="";try{r=this.updateInput(e)}catch(e){return this.callbackRun(n,e,this,null),this}this.deploy_type=1;e=_objectSpread({},t);e.from=t.contractName||this.contractName,e.to=t.contractName||this.contractName,e.data={code:r};r=this.client.UpdateContract;return e.encrypt&&(r=this.client.EncryptedTransaction,e.apiName="UpdateContract"),e.local&&(r=this.client.LocalTransaction,e.apiName="UpdateContract"),r.call(this.client,e,function(e,t){if(e)c.callbackRun(n,e,c,t);else if(0===t.return_code||408===t.return_code)if(t.receipt)if(408!==t.return_code)if(0===t.receipt.result){if(c.callbackRun(n,null,c,t),c.callCache.length)for(var r=c.callCache.shift();r;)c.contractTpl.doPayload(r),r=c.callCache.shift();c.callCache=[]}else c.callbackRun(n,Errors.receiptResult(t.receipt.result),c,t);else c.callbackRun(n,Errors.codeResult(t.return_code,t.receipt.result),c,t);else c.callbackRun(n,Errors.receiptResult(null),c,t);else c.callbackRun(n,Errors.returnCode(t.return_code),c,t)}),this}},{key:"callApi",value:function(e){1===this.deploy_type?this.callCache.push(e):this.contractTpl.doPayload(e)}},{key:"sendTransaction",value:function(e){var t,r,a,l=this,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=2<arguments.length?arguments[2]:void 0,o=3<arguments.length?arguments[3]:void 0;2!==this.deploy_type?e?Util.isFunction(i)&&setTimeout(function(){i(e,null,null)},1):(t=c.extend||null,r=_objectSpread(_objectSpread({},c),{},{to:this.contractName,data:{parameter:c.data||""}}),c=this.client.CallContract,r.encrypt&&(c=this.client.EncryptedTransaction,r.apiName="CallContract"),r.local&&(c=this.client.LocalTransaction,r.apiName="CallContract"),a=!1,r.encrypt&&(a=!0),c.call(this.client,r,function(e,t,r){if(Util.isFunction(i))if(e)i(e,null,t,r);else if(0===t.return_code||408===t.return_code)if(t.receipt)if(10201!==t.receipt.result)if(408!==t.return_code)if(0===t.receipt.result)if(a)i(e,t.receipt.output,t,r);else{t=l.formatLog(t);var c=e,n=null;try{n=l.contractTpl.unpackApiOutput(t.receipt.output,o)}catch(e){c=e}i(c,n,t,r)}else i(Errors.receiptResult(t.receipt.result),null,t,r);else i(Errors.codeResult(t.return_code,t.receipt.result),null,t,r);else{n=null;try{n=l.formatRequireOutput(t.receipt.output)}catch(e){n=null}i(Errors.receiptResult(t.receipt.result,t.hash,n),n,t,r)}else i(new Error("Receipt is null"),null,t,r);else i(Errors.returnCode(t.return_code),null,t,r)},t)):Util.isFunction(i)&&setTimeout(function(){i(Errors.contractDeploy(l.contractName),null,null)},1)}},{key:"callEvent",value:function(t,e,r,c){if(Util.isFunction(r))if(t)r(t,e);else{var n=null;if(e.event_data&&e.event_data.data)try{n=this.contractTpl.unpackEventOutput(e.event_data.data,c)}catch(e){t=e}eventFilterCheck(n,this.contractTpl.eventFilterArr(c))&&r(t,n,e)}}},{key:"on",value:function(){this.contractTpl.on.apply(this.contractTpl,Array.prototype.slice.call(arguments))}},{key:"close",value:function(e,t){this.contractTpl.close(e,t)}},{key:"getOutput",value:function(e,t){return this.contractTpl.getOutput(e,t)}},{key:"formatLog",value:function(e){return this.contractTpl.formatLog(e)}},{key:"formatRequireOutput",value:function(e){return this.contractTpl.formatRequireOutput(e)}}]),u}();module.exports=Contract;