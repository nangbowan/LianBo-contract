"use strict";function ownKeys(t,e){var r,n=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)),n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var tls=require("tls"),Errors=require("./errors"),Util=require("./util"),prime256v1EcdhCurve="prime256v1",TlsGlobalConfig={ecdhCurve:"secp256k1:prime256v1"},TLS=function(){function h(e,t){var r=e.host,n=e.port,o=e.clients,c=e.timeout,s=e.cert,i=e.ca,a=e.key,l=e.passphrase,u=e.checkServerIdentity,e=e.sendCallback;_classCallCheck(this,h),this.callback=t,this.sendCallback=e||"",this.retryNum=0,r&&n?(Array.isArray(o)||(o=[]),o=[{host:r,port:n}].concat(o)):Array.isArray(o)&&o.length&&(r=o[0].host,n=o[0].port),this.clients=o||[],this.currentClient=0,this.resetConnect({host:r,port:n,timeout:c,cert:s,ca:i,key:a,passphrase:l,checkServerIdentity:u})}return _createClass(h,[{key:"doCallback",value:function(e,t){"function"==typeof this.callback&&this.callback(e,t)}},{key:"setConfig",value:function(e){var t=e.host,r=e.port,n=e.timeout,o=e.cert,c=e.ca,s=e.key,i=e.passphrase,e=e.checkServerIdentity;this.host=t||"localhost",this.port=r||"18130",this.timeout=n||3e4,this.cert=o||"",this.ca=c||"",this.key=s||"",this.passphrase=i||"",this.checkServerIdentity=e}},{key:"connect",value:function(){var e=this,t=tls.createSecureContext({cert:this.cert,ca:[this.ca],key:this.key,passphrase:this.passphrase,ciphers:"ALL",ecdhCurve:TlsGlobalConfig.ecdhCurve}),t={host:this.host,port:this.port,secureContext:t};this.checkServerIdentity||(t.checkServerIdentity=function(){});var r=tls.connect(t,function(){r.authorized?(e.retryNum=0,e.doCallback()):e.doCallback(Errors.unauthorized)});return r}},{key:"resetConnect",value:function(r){var n=this;this.setConfig(r),this.socket=this.connect();var o=null;this.socket.on("readable",function(e){var t;(o=o||n.socket.read(Util.HEADER_LEN))&&(t=Util.getTotalLength(o)-Util.HEADER_LEN,(t=n.socket.read(t))&&(t=Util.getTlsPacket(o,t),o=null,"function"==typeof n.sendCallback&&n.sendCallback(e,t.data)))}),this.socket.on("close",function(e){var t;console.log("close",e),n.retryNum<4?(n.retryNum++,setTimeout(function(){n.resetConnect(r)},1e3)):(n.currentClient++,(t=n.clients[n.currentClient])&&setTimeout(function(){n.retryNum=0,n.resetConnect(_objectSpread(_objectSpread({},r),{},{host:t.host,port:t.port}))},1e3))}),this.socket.on("error",function(e){console.log("error",e)})}},{key:"send",value:function(e){e=Util.makeTlsPacket(e);this.socket.write(e,"buffer",function(){})}}]),h}(),TLSType=function(e,t){return new TLS(e,t)};TLSType.setEcdhCurve=function(e){TlsGlobalConfig.ecdhCurve=e},TLSType.setPrime256v1EcdhCurve=function(){this.setEcdhCurve(prime256v1EcdhCurve)},module.exports=TLSType;